---
title: "Casestudy1_Cylistic"
output:
  html_document:
    df_print: paged
  pdf_document: default
---


# Cylistic bike-share casestudy
# Overview
You are a junior data analyst working in the marketing analyst team at Cyclistic, a bike-share company in Chicago. The director of marketing believes the companyâ€™s future success depends on maximizing the number of annual memberships. Therefore, your team wants to understand how casual riders and annual members use Cyclistic bikes differently. From these insights, your team will design a new marketing strategy to convert casual riders into annual members. But first, Cyclistic executives must approve your recommendations, so they must be backed up with compelling data insights and professional data visualizations.

Wellcome to my casestudy project. In this notebook, I will go through my analysis step by step and explain each parts in detail.

##PHARE 1: ASK

Identify the business task: Figure out the differences between riding behavior of casual and member (in term of travel time, distance, bike-type and in weekday ) and then have some insight to create marketing campaign to convert casual customers to annual subscription

Consider key stakeholders: some key stakeholders are the director of marketing who responsible for promoting bike-share program, executive and analysis team.

##PHARE 2: PREPARE

The data is from a bike sharing company from 2013 to first quarter of 2022. The data is good for answering some question but it have some confuse naming convention ( the name of the column in 2020 file change compare to previous year. Ex: Start_at & start_station) and the files sometimes organized by month, quarter or whole year

I will use the data on 2021-2022 period as it is the most recent and more relevant to the business task (creating a marketing campaign), it also have many data (geo-location and byke-type)

####1/ First I input the required library
```{r}
library("tidyverse")
library("ggplot2")
library("lubridate")
library("geosphere")
library("gridExtra") 
library("ggmap")
memory.limit(30000) # set memory limit to work with large files

```

####2/ Set working directory and input files

```{r}
getwd()
setwd("C:/Users/win10pro/Downloads/casestudy1/raw_data/divvy_tripdata")
trip_2021_01 <- read.csv("202101-divvy-tripdata.csv")
trip_2021_02 <- read.csv("202102-divvy-tripdata.csv")
trip_2021_03 <- read.csv("202103-divvy-tripdata.csv")
trip_2021_04 <- read.csv("202104-divvy-tripdata.csv")
trip_2021_05 <- read.csv("202105-divvy-tripdata.csv")
trip_2021_06 <- read.csv("202106-divvy-tripdata.csv")
trip_2021_07 <- read.csv("202107-divvy-tripdata.csv")
trip_2021_08 <- read.csv("202108-divvy-tripdata.csv")
trip_2021_09 <- read.csv("202109-divvy-tripdata.csv")
trip_2021_10 <- read.csv("202110-divvy-tripdata.csv")
trip_2021_11 <- read.csv("202111-divvy-tripdata.csv")
trip_2021_12 <- read.csv("202112-divvy-tripdata.csv")
trip_2022_01 <- read.csv("202201-divvy-tripdata.csv")
trip_2022_02 <- read.csv("202202-divvy-tripdata.csv")
trip_2022_03 <- read.csv("202203-divvy-tripdata.csv")
```

####3/ Combine data into 1 files

```{r}
trip_2021 <- bind_rows(trip_2021_01, trip_2021_02, trip_2021_03, trip_2021_04, trip_2021_05, trip_2021_06, trip_2021_07, trip_2021_08, trip_2021_09, trip_2021_10, trip_2021_11, trip_2021_12)
trip_2022_q1 <- bind_rows(trip_2022_01, trip_2022_02, trip_2022_03)
all_trip <- bind_rows(trip_2021, trip_2022_q1)
str(all_trip)

```

##PHARE3: PROCESS

####4/ Clean data: Drop N/A and create new day, month, year & weekday columns to further calculation

```{r}
all_trip_clean <- drop_na(all_trip)
all_trip_clean$date <- as.Date(all_trip_clean$started_at) 
all_trip_clean$month <- format(as.Date(all_trip_clean$date), "%m")
all_trip_clean$day <- format(as.Date(all_trip_clean$date), "%d")
all_trip_clean$year <- format(as.Date(all_trip_clean$date), "%Y")
all_trip_clean$day_of_week <- format(as.Date(all_trip_clean$date), "%A")
```
####5/ Create some calculation fields  such as distance, speed, duration

```{r}
all_trip_clean$ride_length <- difftime(all_trip_clean$ended_at,all_trip_clean$started_at) #duration

all_trip_clean$ride_distance <- distGeo(matrix(c(all_trip_clean$start_lng, all_trip_clean$start_lat), ncol = 2), matrix(c(all_trip_clean$end_lng, all_trip_clean$end_lat), ncol = 2))  #distance

all_trip_clean$ride_distance <- all_trip_clean$ride_distance/1000  #distance in km

all_trip_clean$ride_speed = c(all_trip_clean$ride_distance)/as.numeric(c(all_trip_clean$ride_length), units="hours") # speed km/h

all_trip_clean <- all_trip_clean[!(all_trip_clean$ride_length<0),]



```

##PHARE 4: ANALYSE

####6/ See the difference between two type of rider in term of travel distance and time

```{r}
#Fist we calculate the average distance, distance for both the casual and member type users:

userType_means <- all_trip_clean %>% group_by(member_casual) %>% summarise(mean_time = mean(ride_length),mean_distance = mean(ride_distance))

view(userType_means)

membervstime <- ggplot(userType_means) + 
  geom_col(mapping=aes(x=member_casual,y=mean_time,fill=member_casual), show.legend = FALSE)+
  labs(title = "Mean travel time by User type",x="User Type",y="Mean time in sec")

membervsdistance <- ggplot(userType_means) + 
  geom_col(mapping=aes(x=member_casual,y=mean_distance,fill=member_casual), show.legend = FALSE)+
  labs(title = "Mean travel distance by User type",x="User Type",y="Mean distance In Km",caption = "Data by Motivate International Inc")

membervsdistance
grid.arrange(membervstime, membervsdistance, ncol = 2) 
```
#### In term of weekday

```{r}
#The we check  the number of rides diferences by weekday:
all_trip_clean %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length),.groups = 'drop') %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = "Number of rides by User type during the week",x="Days of the week",y="Number of rides",caption = "Data by Motivate International Inc", fill="User type") +
  theme(legend.position="top")
```
###Analyse

Casual rider travel almost the same distance with annual members but it take them more time (almost double than member rider) -> a more leisure oriented compare to pragmatic use of member riders (who travel to work and use other transportation)

This idea is reinforce by the fact that Casual riders prefer travel in the weekend while the usage of member riders remain stable during the week  

####Seeing the difference in term of bike types

```{r}
#Create a new table with only the rows with info in the "bike type" column:

with_bike_type <- all_trip_clean %>% filter(rideable_type=="classic_bike" | rideable_type=="electric_bike")

#Then lets check the bike type usage by user type:

with_bike_type %>%
  group_by(member_casual,rideable_type) %>%
  summarise(totals=n(), .groups="drop")  %>%
  ggplot()+
  geom_col(aes(x=member_casual,y=totals,fill=rideable_type), position = "dodge") + 
  labs(title = "Bike type usage by user type",x="User type",y=NULL, fill="Bike type") +
  scale_fill_manual(values = c("classic_bike" = "#746F72","electric_bike" = "#FFB100")) +
  theme_minimal() +
  theme(legend.position="top")

```




```{r}

#And their usage by both user types during a week:

with_bike_type %>%
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual,rideable_type,weekday) %>%
  summarise(totals=n(), .groups="drop") %>%
  
  ggplot(aes(x=weekday,y=totals, fill=rideable_type)) +
  geom_col(, position = "dodge") + 
  facet_wrap(~member_casual) +
  labs(title = "Bike type usage by user type during a week",x="User type",y=NULL,caption = "Data by Motivate International Inc") +
  scale_fill_manual(values = c("classic_bike" = "#746F72","electric_bike" = "#FFB100")) +
  theme_minimal() +
  theme(legend.position = "none")
```
###Analyse
Annual member show a clear preference of classic bike while casual riders uses more classic bike at the weekend

##Further Analysis
I refer to some of this casestudy analysis and find the way to present the most use route by 2 type of user which is very interesting

```{r}
#Lets check now the coordinates data of the rides, to see if is there any interesting pattern:

#First we create a table only for the most popular routes (>250 times)
coordinates_table <- all_trip_clean %>% 
filter(start_lng != end_lng & start_lat != end_lat) %>%
group_by(start_lng, start_lat, end_lng, end_lat, member_casual, rideable_type) %>%
summarise(total = n(),.groups="drop") %>%
filter(total > 250)

#Then we create two sub tables for each user type
casual <- coordinates_table %>% filter(member_casual == "casual")
member <- coordinates_table %>% filter(member_casual == "member")

#Lets store bounding box coordinates for ggmap:
chi_bb <- c(
  left = -87.700424,
  bottom = 41.790769,
  right = -87.554855,
  top = 41.990119
)

#Here we store the stamen map of Chicago
chicago_stamen <- get_stamenmap(
  bbox = chi_bb,
  zoom = 12,
  maptype = "toner"
)
```

```{r}
#Then we plot the data on the map
ggmap(chicago_stamen,darken = c(0.8, "white")) +
   geom_curve(casual, mapping = aes(x = start_lng, y = start_lat, xend = end_lng, yend = end_lat, alpha= total, color=rideable_type), size = 0.5, curvature = .2,arrow = arrow(length=unit(0.2,"cm"), ends="first", type = "closed")) +
    coord_cartesian() +
    labs(title = "Most popular routes by casual users",x=NULL,y=NULL, color="User type", caption = "Data by Motivate International Inc") +
    theme(legend.position="none")

ggmap(chicago_stamen,darken = c(0.8, "white")) +
    geom_curve(member, mapping = aes(x = start_lng, y = start_lat, xend = end_lng, yend = end_lat, alpha= total, color=rideable_type), size = 0.5, curvature = .2,arrow = arrow(length=unit(0.2,"cm"), ends="first", type = "closed")) +  
    coord_cartesian() +
    labs(title = "Most popular routes by annual members",x=NULL,y=NULL, caption = "Data by Motivate International Inc") +
    theme(legend.position="none")
```


##PHARE 5: SHARE



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
