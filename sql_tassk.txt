#See top 100 client base on loan_amount of active contract
SELECT F_CONTRACT_BASE_AD.SKP_CLIENT
      ,COUNT(F_CONTRACT_BASE_AD.SKP_CONTRACT) AS NUMBER_ACTIVE_CONTRACT
      ,SUM(F.CONTRACT_BASE_AD.AMT_CREDIT_LOAN) AS LOAN_AMOUNT

FROM F_CONTRACT_BASE_AD JOIN 
				(SELECT * 
				FROM DC_PRODUCT 
				WHERE DC_PRODUCT.FLAG_ACTIVE = 'Y') 
as ACTIVE_PRODUCT
   ON F.CONTRACT_BASE_AD.SKP_PRODUCT = ACTIVE_PRODUCT.SKP_PRODUCT

GROUP BY F_CONTRACT_BASE_AD.SKP_CLIENT
ORDER BY NUMBER_ACTIVE_CONTRACT DESC, LOAN_AMOUNT DESC
LIMIT 100;

# select contract sign during 2013 with information about loan amount, client and client address

WITH A AS (
	SELECT SKP_CONTRACT,
		SKP_CLIENT,
		SUM(AMT_CREDIT_LOAN) AS LOAN_AMOUNT
	FROM F_CONTRACT_BASE_AD
	GROUP BY SKP_CONTRACT
)
,
WITH RESULT_1 AS (

SELECT A.* , 
	DC_CONTRACT.DATE_SIGNATURE_CONTRACT,
	DC_CONTRACT.DATE_LAST_PAYMENT,
	DC_ADDRESS.*
FROM A 
JOIN DC_CONTRACT ON A.SKP_CONTRACT = DC_CONTRACT.SKP_CONTRACT
JOIN DC_CLIENT ON A.SKP_CLIENT = DC_CLIENT.SKP_CLIENT
JOIN DC_ADDRESS ON DC_CLIENT.SKP_ADDRESS = DC_ADDRESS.SKP_ADDRESS

WHERE DC_CONTRACT.DATE_SIGNATURE_CONTRACT >= '01/01/2013'
AND   DC_CONTRACT.DATE_SIGNATURE_CONTRACT < '01/01/2014'
)

SELECT * FROM RESULT_1

# find out loan amount and it's percentage share by city

with C as (
SELECT 
CASE 
WHEN NAME_PROVINCE NOT IN ('TP.HCM', 'HA NOI', 'DA NANG') THEN 'OTHERS'
ELSE NAME_PROVINCE
END AS PROVINCE_GROUP ,
SUM (LOAN_AMOUNT) as Loan_by_province

FROM RESULT_1
GROUP BY PROVINCE_GROUP)

select province_group, 
	Loan_by_province,
	Loan_by_province *100/ (select sum(Loan_by_province) from C) as percentage_share
from C;
      